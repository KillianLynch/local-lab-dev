# Working with JSON and the Duality Views

## Introduction

In this lab, you will explore the power of duality views, which allow you to seamlessly work with both Relational and JSON data in the Oracle Database. You will learn how to create duality views, populate them with data using SQL or JSON, and perform operations on the integrated data. Get ready to harness the flexibility and convenience of JSON Relational Duality Views!

This lab is only intended to give you a small taste of what duality views have to offer. For a full, in-depth free workshops, follow the link below

[23c JSON Duality View Workshops](https://apexapps.oracle.com/pls/apex/f?p=133:100:110578183178299::::SEARCH:duality%20views)

Estimated Time: 20 minutes

### Objectives

In this lab, you will:

* Install the needed tables 
* Create and populate the duality views
* Learn what you can do with duality views  

### Prerequisites

This lab assumes you have:

* Oracle Database 23c
* Completed the get started Lab


## Task 1: Setup

1. first we'll set up the lab. Enable the lab setup script to be executable 

    ```
    <copy>
    chmod +x setup.sh
    </copy>
    ```

2. Run the script

    ```
    <copy>
    ./setup.sh
    </copy>
    ```

3. Copy the following into the Google Chrome search bar

    ```
    <copy>
    http://localhost:8080/ords/sql-developer
    </copy>
    ```

4. Sign in to SQL Developer Web using the movie schema with the **username movie and password movie**.

    ![Ords login](images/ords-url.png " ")

5. CLick on the SQL tile. 

    ![Ords login](images/sql-tile.png " ")

6. Lets create some tables to use in the lab. Copy and run the following as a script.

    ```
    <copy>
    create table if not exists GENRES
    (
        GENRE_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY not null constraint GENRE_PK primary key,
        GENRE_NAME VARCHAR2(200),
        GENRE_DESCRIPTION VARCHAR2(200)
    );

    create table if not exists MOVIE_DETAILS
    (
        MOVIE_ID     NUMBER not null constraint MOVIE_DETAILS_PK primary key,
        TITLE        VARCHAR2(200),
        BUDGET       NUMBER,
        GROSS        NUMBER,
        LIST_PRICE   NUMBER,
        SKU          VARCHAR2(30),
        YEAR         NUMBER,
        OPENING_DATE DATE,
        VIEWS        NUMBER,
        MAIN_SUBJECT VARCHAR2(4000),
        RUNTIME      NUMBER,
        SUMMARY      VARCHAR2(4000)
    );

    create table if not exists MOVIES_GENRE_MAP
    (
        MG_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
        MOVIE_ID NUMBER,
        GENRE_ID NUMBER
    );

    alter table MOVIES_GENRE_MAP
        add constraint MOVIES_GENRE_MAP_PK
            primary key (MG_ID);

    alter table MOVIES_GENRE_MAP
        add constraint MOVIES_GENRE_MAP_uk unique (MOVIE_ID, GENRE_ID);

    alter table MOVIES_GENRE_MAP
        add constraint MOVIES_GENRE_MAP_fk
            foreign key (GENRE_ID) references GENRES (GENRE_ID) ;

    alter table MOVIES_GENRE_MAP
        add constraint MOVIES_GENRE_MAP_fk2
            foreign key (MOVIE_ID) references MOVIE_DETAILS (MOVIE_ID) ;

	</copy>
    ```
7. Add some data to the tables

    ```
    <copy>
    -- Inserting data into GENRES table
    INSERT INTO GENRES (GENRE_NAME, GENRE_DESCRIPTION) VALUES ('Action', 'Movies with high-octane action scenes');
    INSERT INTO GENRES (GENRE_NAME, GENRE_DESCRIPTION) VALUES ('Comedy', 'Movies that aim to make people laugh');
    INSERT INTO GENRES (GENRE_NAME, GENRE_DESCRIPTION) VALUES ('Drama', 'Movies that focus on realistic characters and emotional themes');

    -- Inserting data into MOVIE_DETAILS table
    INSERT INTO MOVIE_DETAILS (MOVIE_ID, TITLE, BUDGET, GROSS, LIST_PRICE, SKU, YEAR, OPENING_DATE, VIEWS, MAIN_SUBJECT, RUNTIME, SUMMARY)
    VALUES (1, 'The Avengers', 250000000, 1518812988, 19.99, 'AVENGERS001', 2012, TO_DATE('2012-05-04', 'YYYY-MM-DD'), 1000000, 'Superheroes', 143, 'Earths mightiest heroes must come together and learn to fight as a team if they are going to stop the mischievous Loki and his alien army from enslaving humanity.');
    INSERT INTO MOVIE_DETAILS (MOVIE_ID, TITLE, BUDGET, GROSS, LIST_PRICE, SKU, YEAR, OPENING_DATE, VIEWS, MAIN_SUBJECT, RUNTIME, SUMMARY)
    VALUES (2, 'The Shawshank Redemption', 25000000, 58900000, 14.99, 'SHAWSHANK001', 1994, TO_DATE('1994-10-14', 'YYYY-MM-DD'), 500000, 'Redemption', 142, 'Two imprisoned men bond over a number of years, finding solace and eventual redemption through acts of common decency.');

    INSERT INTO MOVIE_DETAILS (MOVIE_ID, TITLE, BUDGET, GROSS, LIST_PRICE, SKU, YEAR, OPENING_DATE, VIEWS, MAIN_SUBJECT, RUNTIME, SUMMARY)
    VALUES (3, 'Inception', 160000000, 836800000, 24.99, 'INCEPTION001', 2010, TO_DATE('2010-07-16', 'YYYY-MM-DD'), 1200000, 'Dreams', 148, 'A thief who enters the dreams of others to steal their secrets from their subconscious.');

    -- Inserting data into MOVIES_GENRE_MAP table

    INSERT INTO MOVIES_GENRE_MAP (MOVIE_ID, GENRE_ID) VALUES (1, 1);
    INSERT INTO MOVIES_GENRE_MAP (MOVIE_ID, GENRE_ID) VALUES (2, 3);
    INSERT INTO MOVIES_GENRE_MAP (MOVIE_ID, GENRE_ID) VALUES (3, 1);
    INSERT INTO MOVIES_GENRE_MAP (MOVIE_ID, GENRE_ID) VALUES (3, 3);
	</copy>
    ```
## Task 1: Create the duality views

1. We create Duality Views by defining the documents structure and describing where the data comes from. The following Duality View we create will list the `genres` table information. We can also define each operation against the underlying table. Here we are setting `WITH INSERT UPDATE DELETE`. 
    
    Create the `genres_dv` duality view. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Copy the sql below and click **Run Script**

    ```
    <copy>
    CREATE OR REPLACE JSON DUALITY VIEW genres_dv AS
    SELECT JSON {'genre_id' : g.GENRE_ID,
            'genre_name' : g.GENRE_NAME,
            'genre_description' : g.GENRE_DESCRIPTION}
    FROM genres g WITH INSERT UPDATE DELETE;
	</copy>
    ```
	![Creating the genre view](images/genre-dv.png " ")

2. On the other hand, we can use a GraphQL syntax to create the view. In this example we will create the `movies_dv` duality view. With GraphQL we will rely on the database to work out the relationships between the tables. The `movies_dv` lists out movie details including an array of genres. We will also set this view to @insert, @update, @delete. You can either click the trash icon to clear the worksheet or delete what is there before pasting the code below. Copy the GraphQL syntax below and click **Run Script**

	```
	<copy>
    CREATE OR REPLACE JSON DUALITY VIEW movies_dv
        AS MOVIE_DETAILS @insert @update @delete
        {
            movie_id : MOVIE_ID
            title : TITLE
            budget : BUDGET
            list_price : LIST_PRICE
            year : YEAR
            runtime : RUNTIME
            summary : SUMMARY
        genres : MOVIES_GENRE_MAP @insert @update @delete {
                GenreToMovieID : MG_ID
                GENRES
                @unnest {
                    genre_id : GENRE_ID,
                    genre_name : GENRE_NAME,
                    genre_description: GENRE_DESCRIPTION}
                }
     };
	</copy>
    ```
    ![Creating the movie view](images/movies-dv.png " ")

3. Now that we have our Duality Views created, lets see how the `genres_dv` looks. Copy the sql below and click **Run Script**

	```
	<copy>
    SELECT json_serialize(data PRETTY) FROM genres_dv;
	</copy>
    ```
    ![Showing the movie view](images/movie-dv-select.png " ")

## Task 2: Adding to our movie schema
1. Insert a new genre into the `GENRES_DV` table to include kid-friendly movies. Copy the sql below and click **Run Statement**

	```
	<copy>
    INSERT INTO GENRES_DV VALUES('{"genre_name" : "Kids"}');
	</copy>
    ```
    ![adding into genre](images/kids.png " ")

2. Populating a duality view automatically updates the data shown in related duality views by updating their underlying tables. Lets take a look at the `genres_dv` Duality View. Copy the sql below and click **Run Script**:

    ```
    <copy>
    SELECT json_serialize(data PRETTY) FROM GENRES_DV g WHERE g.data.genre_name = 'Kids';
    </copy>
    ```
    ![Adding the Kids genre](images/kids-genre.png " ")

3. Insert a collection of documents into `MOVIES_DV`. This automatically populates the `MOVIE_DETAILS` and the `MOVIE_GENRE_MAPPING` table. If you remember the movies duality view joins movie_details and movies to genre mappings. It also allows inserts into both tables. Copy the sql below and click **Run Script**

    ```
    <copy>
    INSERT INTO MOVIES_DV VALUES('{ "movie_id" : 4004,
                                "title" : "Surfs Up",
                                "budget" : 100000000,
                                "list_price" : 0,
                                "year" : 2007,
                                "runtime" : 85,
                                "summary" : "Surfing means everything to teenage penguin Cody Maverick. Followed by a documentary film crew, he leaves his home in Antarctica for Pen Gu Island, site of the the Big Z Memorial Surf Off. Cody wants to be respected and admired, and he believes that winning the competition will bring him what he craves. However, an encounter with washed-up surfer Geek teaches Cody about what is truly important.",
                                "genres" : [{"genre_id" : 25,
                                            "genre_name" : "Kids"},
                                            {"genre_id" : 10,
                                            "genre_name" : "Family"}]}'
    );
    
    INSERT INTO MOVIES_DV VALUES('{ "movie_id" : 4005,
                                "title" : "Rango",
                                "budget" : 135000000,
                                "list_price" : 0,
                                "year" : 2011,
                                "runtime" : 107,
                                "summary" : "A chameleon (Johnny Depp) who has lived as a sheltered family pet finds himself in the grip of an identity crisis. Rango wonders how to stand out when it is his nature to blend in. When he accidentally winds up in a frontier town called Dirt, he takes the first step on a transformational journey as the towns new sheriff. Though at first Rango only role-plays, a series of thrilling situations and outrageous encounters forces him to become a real hero.",
                                "genres" : [
                                    
                                ]}'
    );
	</copy>
	```
	![adding new movies](images/surfs.png " ")


4. To reiterate, populating a duality view automatically updates the data shown in related duality views by updating their underlying tables. For example, inserting documents into the `MOVIES_DV` duality view updates both the `MOVIE_DETAILS` table and the `movies_genre_map` table.

    To verify the changes, list the contents of the `MOVIES_DV` duality view. Copy the sql below and click **Run Script**:

    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM movies_dv WHERE json_value(data, '$.title') IN ('Surfs Up', 'Rango');
    </copy>
    ```
    ![selecting the surfs up movie ](images/select-surfs.png " ")


5. Alternativly, we could look in the Movie_details table for our new movies, Surfs up and Rango.

    ```
    <copy>
    SELECT * FROM MOVIE_DETAILS WHERE TITLE IN ('Surf''s Up', 'Rango');
    </copy>
    ```

## Task 1: Inserting into SQL tables and duality views
1. To demonstrate how the underlying base tables are populated when adding an entry into the JSON Duality View, we will first check the base table to ensure the record does not exist. Then, we will insert a record into the duality view and check the base table again. Copy the sql below and click **Run Script**

    ```
    <copy>
    SELECT * FROM movie_details where title = 'Stuart Little';

    INSERT INTO MOVIES_DV VALUES('{ "movie_id" : 4006,
                                "title" : "Stuart Little",
                                "budget" : 103000000,
                                "list_price" : 0,
                                "year" : 1999,
                                "runtime" : 83,
                                "summary" : "When the Littles go to an orphanage to adopt a new family member, a charming young mouse named Stuart is chosen. While George is initially unwelcoming so, he shows his beloved new family that great things can truly come in small packages.",
                                "genres" : [{"genre_id" : 25,
                                            "genre_name" : "Kids"},
                                            {"genre_id" : 10,
                                            "genre_name" : "Family"}]}'
    );

    SELECT * FROM movie_details where title = 'Stuart Little';
    </copy>
    ```
    ![adding the movie](images/little.png " ")

2. In this step, we will perform the opposite operation. First, we will look at the duality view, then insert a record into the base table, and finally check the duality view for the updated record. Copy the sql below and click **Run Script**
    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM GENRES_DV WHERE json_value(data, '$.genre_name') = 'Psychological Thriller';

    INSERT INTO genres
    VALUES(26, 'Psychological Thriller', 'Psychological Thriller: mind-bending suspense, intricate narratives, and gripping twists that keep you on edge. Prepare for intense psychological tension and thrilling storytelling.');

    SELECT json_serialize(data PRETTY)
    FROM GENRES_DV WHERE json_value(data, '$.genre_name') = 'Psychological Thriller';

    </copy>
    ```
    
    ![adding a new description](images/psy_thriller.png " ")

## Task 2: Duality View benefits

1. Like the previous lab, lets make an update to the `GENRES_DV`. The important thing to note here is, this change will be reflected in **all documents** that contain the Kids genre. Copy the sql below and click **Run Script**

    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM GENRES_DV WHERE json_value(data, '$.genre_name') = 'Kids';
    </copy>
    ```
    We can see that the Kids genre exists but has no description. Let's update this via SQL.

    ![showing the genre 25 description is not there](images/no_description.png " ")

2. Let's update the description of the Kids genre. Copy the sql below and click **Run Statement**
 
    ```
    <copy>
    UPDATE GENRES
    SET GENRE_DESCRIPTION = 'Kids genre: captivating, educational, and imaginative films that bring joy to young viewers. Explore enchanting adventures and relatable characters, creating cherished memories for families.'
    WHERE GENRE_ID = 25;
    </copy>
    ```
    ![showing the update ](images/kids_description.png " ")

3. Now, let's check the `GENRES` table again to see the updated description. Copy the sql below and click **Run Script**
    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM GENRES_DV WHERE json_value(data, '$.genre_name') = 'Kids';
    </copy>
    ```
    We can see that the Kids genre now has a new description.

    ![showing the new kids description](images/new_kids_genre.png " ")

4. Next, let's examine all movies that contain the Kids genre to see the updated description. Copy the sql below and click **Run Script**
    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM movies_dv WHERE json_value(data, '$.movie_id') IN (4004, 4005, 2355, 4006);
    </copy>
    ```
    ![showing all the movies with the kids genre](images/updated_kids_description.png " ")

5. Finally, since we made an update via a SQL INSERT statement, let's insert a record via the Duality View. We will add a description to the Family genre. First, check the current description. Copy the sql below and click **Run Script**

    ```
    <copy>
    SELECT GENRE_DESCRIPTION FROM GENRES WHERE GENRE_NAME = 'Family';
    </copy>
    ```
    ![checking for a description in the family genre](images/fam_description.png " ")

6. Update the Genres Duality View and add the description for the Family genre. Copy the sql below and click **Run Script**
    ```
    <copy>
    UPDATE GENRES_DV g set g.data = json_transform(data, SET '$.genre_description' = 'Family: Heartwarming and inclusive entertainment for all ages. Dive into a world of love, laughter, and togetherness as you embark on delightful adventures and celebrate the power of family bonds.') WHERE g.data.genre_name = 'Family';
    </copy>
    ```
    ![adding a genre description to family](images/family_update.png " ")

7. Lastly, let's check the Duality Views containing the Family genre to see the updated description. Copy the sql below and click **Run Script**
    ```
    <copy>
    SELECT json_serialize(data PRETTY)
    FROM movies_dv WHERE json_value(data, '$.movie_id') IN (4004, 4005, 2355, 4006, 123, 124, 167, 190, 198, 212, 227);
    </copy>
    ```
    ![checking to see the changes were made](images/family_proof.png " ")



8. In summary, this lab demonstrated the power of JSON Relational Duality Views, allowing you to work with data in either JSON Document format or SQL Relational format. Changes made through views are reflected in the corresponding documents and tables. This flexibility enables efficient and convenient create, read, update or delete across multiple documents and tables with ease.


## Learn More

* [JSON Relational Duality: The Revolutionary Convergence of Document, Object, and Relational Models](https://blogs.oracle.com/database/post/json-relational-duality-app-dev)
* [JSON Duality View documentation](http://docs.oracle.com)
* [Blog: Key benefits of JSON Relational Duality] (https://blogs.oracle.com/database/post/key-benefits-of-json-relational-duality-experience-it-today-using-oracle-database-23c-free-developer-release)

## Acknowledgements
* **Author** - Killian Lynch, Oracle Database Product Management, Product Manager
* **Contributors** - Dominic Giles, Oracle Database Product Management, Distinguished Product Manager
* **Last Updated By/Date** - Killian Lynch, Oracle Database Product Management, Product Manager, May 2023
